(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[498],{1054:function(){},4816:function(e,t,r){Promise.resolve().then(r.bind(r,7133))},7133:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return m}});var a=r(9533),o=r(1229),c=r(1250),n=r(5481),s=r(6289),i=r.n(s),l=r(2629),u=r.n(l);function d(){let e=(0,c.useRouter)(),t=(0,c.useSearchParams)(),[r,s]=(0,o.useState)(!1),[l,d]=(0,o.useState)(!1),[m,p]=(0,o.useState)(null),[g,h]=(0,o.useState)([]),[f,_]=(0,o.useState)(!0),[b,T]=(0,o.useState)(!1),[y,S]=(0,o.useState)(null),[k,w]=(0,o.useState)(!1),[N,x]=(0,o.useState)(null),I=(0,o.useRef)(null),v=(0,o.useRef)(!1),B=(0,o.useRef)(void 0),C=(0,o.useRef)(0),j=(0,o.useRef)(null),O=(0,o.useRef)(null),E=t.get("id"),D=t.get("chapter"),J=t.get("source")||"source2",P=()=>{if(!I.current)return 0;let e=I.current,t=e.scrollTop,r=e.scrollHeight,a=e.clientHeight;return r<=a?100:Math.min(100,Math.max(0,Math.round(t/(r-a)*100)))},H=(0,o.useCallback)(e=>{try{let t=(0,n.n5)(),r=P(),a={bookId:E,chapterId:e.ccid,chapterTitle:e.title,progress:r,timestamp:Date.now()},o="bookmarks_".concat(t,"_").concat(E),c=localStorage.getItem(o),s=[];c&&(s=JSON.parse(c));let i=s.findIndex(t=>t.chapterId===e.ccid);i>=0?s[i]=a:s.push(a),localStorage.setItem(o,JSON.stringify(s));let l="currentReading_".concat(t,"_").concat(E);localStorage.setItem(l,JSON.stringify({chapterId:e.ccid,chapterTitle:e.title,progress:r,timestamp:Date.now()}))}catch(e){console.error("更新书签失败:",e)}},[E]);(0,o.useEffect)(()=>{(async()=>{if(E)try{let e=await (0,n.mG)(E);x(e.title)}catch(e){console.error("获取书籍信息失败:",e)}})()},[E]),(0,o.useEffect)(()=>(N?D&&m&&m.title?document.title="<<".concat(N,">>-微米小说-").concat(m.title):document.title="<<".concat(N,">>-微米小说"):document.title="微米小说",()=>{document.title="微米小说"}),[N,m,D]),(0,o.useEffect)(()=>{if(E)try{let e=(0,n.n5)(),t="bookmarks_".concat(e,"_").concat(E),r=localStorage.getItem(t);r?JSON.parse(r):console.log("没有找到书签数据")}catch(e){console.error("检查书签数据失败:",e)}},[E]),(0,o.useEffect)(()=>{let t=async()=>{try{_(!0),S(null);let t=D;if(!t)try{let r=(0,n.n5)(),a="bookmarks_".concat(r,"_").concat(E),o=localStorage.getItem(a);if(o){let r=JSON.parse(o);if(r&&r.length>0){let a=r.sort((e,t)=>(t.timestamp||0)-(e.timestamp||0))[0];a&&a.chapterId&&(t=a.chapterId,e.replace("/book/read?id=".concat(E,"&chapter=").concat(t)))}}}catch(e){console.error("检查书签记录失败:",e)}if(!t){let e=(await (0,n.Z)({cbid:E,pageNum:1,pageSize:20})).resultData.filter(e=>-1===e.chapterType||1===e.chapterType);if(e.length>0)t=e[0].ccid;else{S("没有找到符合条件的章节（chapterType 为 -1 或 1）"),_(!1);return}}if(t){let e=await (0,n.Kr)({cbid:E,ccid:t}),r={id:e.ccid,ccid:e.ccid,title:e.chapterTitle||"",content:e.content||"",nextCcid:e.nextCcid};p(r),h([{id:r.ccid,ccid:r.ccid,title:r.title,content:r.content,chapterOrder:e.chapterOrder||0}]),B.current=e.nextCcid,w(!!e.nextCcid),O.current&&(clearTimeout(O.current),O.current=null),setTimeout(()=>{try{let e=(0,n.n5)(),t="currentReading_".concat(e,"_").concat(E);localStorage.setItem(t,JSON.stringify({chapterId:r.ccid,chapterTitle:r.title,progress:0,timestamp:Date.now()}));let a="bookmarks_".concat(e,"_").concat(E),o=localStorage.getItem(a),c=[];o&&(c=JSON.parse(o));let s={bookId:E,chapterId:r.ccid,chapterTitle:r.title,progress:0,timestamp:Date.now()},i=c.findIndex(e=>e.chapterId===r.ccid);i>=0?c[i]=s:c.push(s),localStorage.setItem(a,JSON.stringify(c)),O.current=setTimeout(()=>{try{let e=P(),o=r.ccid,c=localStorage.getItem(t);if(c&&JSON.parse(c).chapterId===o){localStorage.setItem(t,JSON.stringify({chapterId:o,chapterTitle:r.title,progress:e,timestamp:Date.now()}));let c=localStorage.getItem(a);if(c){let t=JSON.parse(c),r=t.findIndex(e=>e.chapterId===o);r>=0&&(t[r]={...t[r],progress:e,timestamp:Date.now()},localStorage.setItem(a,JSON.stringify(t)))}}}catch(e){console.error("30秒后更新进度失败:",e)}},3e4)}catch(e){console.error("更新阅读记录失败:",e)}},100)}}catch(e){console.error("获取章节数据失败:",e),S(e instanceof Error?e.message:"获取章节数据失败")}finally{_(!1)}};E&&t()},[E,D,H]),(0,o.useEffect)(()=>{m&&(()=>{try{let e=(0,n.n5)(),t="bookmark_clicked_".concat(e,"_").concat(E),r=localStorage.getItem(t),a="bookmark_closed_".concat(e,"_").concat(E),o=localStorage.getItem(a);"true"===r||"true"===o?s(!1):s(!0)}catch(e){console.error("检查书签失败:",e),s(!0)}})()},[E,m]),(0,o.useEffect)(()=>{if(m&&I.current&&!f)try{let e=(0,n.n5)(),t="currentReading_".concat(e,"_").concat(E),r=localStorage.getItem(t);if(r){let e=JSON.parse(r);e.chapterId===m.ccid&&void 0!==e.progress&&setTimeout(()=>{if(!I.current)return;let t=I.current,r=t.scrollHeight,a=t.clientHeight;if(r<=a)return;let o=Math.min(100,Math.max(0,e.progress));t.scrollTop=o/100*(r-a)},200)}}catch(e){console.error("恢复阅读位置失败:",e)}},[null==m?void 0:m.ccid,f,E]);let A=(0,o.useCallback)(e=>{if(!document.getElementById(e))return;if(!window.TencentGDT||!window.TencentGDT.NATIVE){setTimeout(()=>A(e),500);return}let t="7235826098733219";window.TencentGDT.push({app_id:"1213013256",placement_id:t,type:"native",muid_type:"1",count:1,onComplete:function(r){r&&r.constructor===Array?window.TencentGDT.NATIVE.renderAd(r[0],e):setTimeout(function(){window.TencentGDT.NATIVE.loadAd(t)},3e3)}})},[]),R=(0,o.useCallback)(async e=>{if(e&&!v.current)try{var t;v.current=!0,T(!0);let r=await (0,n.Kr)({cbid:E,ccid:e}),a={id:r.ccid,ccid:r.ccid,title:r.chapterTitle||"",content:r.content||"",nextCcid:r.nextCcid},o=(null===(t=I.current)||void 0===t?void 0:t.scrollTop)||0,c=(null==m?void 0:m.ccid)||null;if(O.current&&(clearTimeout(O.current),O.current=null),c)try{let e=(0,n.n5)(),t="bookmarks_".concat(e,"_").concat(E),r=localStorage.getItem(t);if(r){let e=JSON.parse(r),a=e.findIndex(e=>e.chapterId===c);a>=0&&(e[a]={...e[a],progress:100,timestamp:Date.now()},localStorage.setItem(t,JSON.stringify(e)))}}catch(e){console.error("更新上一章节进度失败:",e)}p(a),j.current=c,h(e=>{let t=[...e,{id:a.ccid,ccid:a.ccid,title:a.title,content:a.content,chapterOrder:r.chapterOrder||0}];return setTimeout(()=>{let e=t.length-1;if(e>0){let t="adContainer_chapter_".concat(a.ccid,"_").concat(e);A(t)}},100),t}),B.current=r.nextCcid,w(!!r.nextCcid),C.current=Date.now(),await new Promise(e=>setTimeout(e,100)),I.current&&(I.current.scrollTop=o);try{let e=(0,n.n5)(),t="currentReading_".concat(e,"_").concat(E);localStorage.setItem(t,JSON.stringify({chapterId:a.ccid,chapterTitle:a.title,progress:0,timestamp:Date.now()}));let r="bookmarks_".concat(e,"_").concat(E),o=localStorage.getItem(r),c=[];o&&(c=JSON.parse(o));let s={bookId:E,chapterId:a.ccid,chapterTitle:a.title,progress:0,timestamp:Date.now()},i=c.findIndex(e=>e.chapterId===a.ccid);i>=0?c[i]=s:c.push(s),localStorage.setItem(r,JSON.stringify(c)),O.current=setTimeout(()=>{try{let e=P(),o=a.ccid,c=localStorage.getItem(t);if(c&&JSON.parse(c).chapterId===o){localStorage.setItem(t,JSON.stringify({chapterId:o,chapterTitle:a.title,progress:e,timestamp:Date.now()}));let c=localStorage.getItem(r);if(c){let t=JSON.parse(c),a=t.findIndex(e=>e.chapterId===o);a>=0&&(t[a]={...t[a],progress:e,timestamp:Date.now()},localStorage.setItem(r,JSON.stringify(t)))}}}catch(e){console.error("30秒后更新进度失败:",e)}},3e4)}catch(e){console.error("更新阅读记录失败:",e)}}catch(e){console.error("加载下一章失败:",e)}finally{v.current=!1,T(!1)}},[E,H]);return((0,o.useEffect)(()=>{if(!I.current||!m)return;let e=null,t=0,r=()=>{t++;let r=I.current;if(!r||v.current)return;let a=Date.now()-C.current;a<1e3||(e&&clearTimeout(e),e=setTimeout(()=>{let e=r.scrollTop,t=r.scrollHeight,o=r.clientHeight,c=t-e-o,n=B.current,s=t>o;(s&&c<=100||s&&0===c&&e>0||!s&&0===c&&a>=1e3)&&n&&!v.current&&a>=1e3&&R(n)},200))},a=I.current;a&&setTimeout(()=>{let e=a.scrollHeight,t=a.clientHeight,r=Date.now()-C.current;!(e>t)&&B.current&&!v.current&&r>=1e3&&R(B.current)},500),a.addEventListener("scroll",r,{passive:!0});let o=0,c=0,n=0,s=e=>{o=e.touches[0].clientY,n=Date.now()},i=e=>{c=e.changedTouches[0].clientY;let t=o-c,r=Date.now()-n;if(!a)return;let s=a.scrollHeight,i=a.clientHeight,l=a.scrollTop,u=s>i,d=Date.now()-C.current;if(!u&&t>0&&B.current&&!v.current&&d>=1e3){R(B.current);return}u&&t>20&&r<800&&s-l-i<=50&&B.current&&!v.current&&d>=1e3&&R(B.current)};return a.addEventListener("touchstart",s,{passive:!0}),a.addEventListener("touchend",i,{passive:!0}),()=>{a.removeEventListener("scroll",r),a.removeEventListener("touchstart",s),a.removeEventListener("touchend",i),e&&clearTimeout(e)}},[null==m?void 0:m.ccid,R]),(0,o.useEffect)(()=>()=>{O.current&&(clearTimeout(O.current),O.current=null)},[]),f)?(0,a.jsx)("main",{className:i().pageBase2,children:(0,a.jsx)("div",{style:{padding:"20px",textAlign:"center",color:"#666"},children:"加载中..."})}):y||!m?(0,a.jsx)("main",{className:i().pageBase2,children:(0,a.jsx)("div",{style:{padding:"20px",textAlign:"center",color:"#f06e2b"},children:y||"章节不存在"})}):(0,a.jsxs)("main",{className:i().pageBase2,children:[(0,a.jsxs)("header",{className:u().header,children:[(0,a.jsx)("button",{className:i().backButtonBase,onClick:()=>e.push("/book?id=".concat(E)),children:(0,a.jsx)("img",{src:"/fh@2x.png",alt:"返回",width:32,height:32,className:i().backIconBase})}),N&&(0,a.jsx)("div",{className:u().bookTitle,children:N}),(0,a.jsx)("button",{className:u().catalogButton,onClick:()=>e.push("/book/catalog?id=".concat(E)),children:"目录"})]}),(0,a.jsxs)("div",{ref:I,className:u().content,children:[g.map((e,t)=>{let r="adContainer_chapter_".concat(e.ccid,"_").concat(t);return(0,a.jsxs)("div",{children:[t>0&&(0,a.jsx)("div",{id:r,style:{margin:"20px 0",minHeight:"10px"}}),(0,a.jsx)("h1",{className:u().chapterTitle,children:e.title}),(0,a.jsx)("div",{className:u().textContent,children:(0,a.jsx)("div",{className:u().chapterSection,children:e.content.split("\r\n").map((t,r)=>t.trim()&&(0,a.jsx)("p",{className:u().paragraph,children:t.trim()},"".concat(e.ccid,"-").concat(r)))})})]},e.ccid)}),b&&(0,a.jsx)("div",{style:{padding:"20px",textAlign:"center",color:"#666"},children:"加载下一章中..."}),!b&&!k&&(0,a.jsx)("div",{style:{padding:"20px",textAlign:"center",color:"#999"},children:"已到最后一章"})]}),r&&(0,a.jsxs)("div",{className:"".concat(u().bookmarkBar," ").concat("source2"===J?u().bookmarkBarBubble:""),children:[(0,a.jsxs)("div",{className:u().bookmarkTextContainer,children:[(0,a.jsx)("div",{className:u().bookmarkText,children:"喜欢本书，加入书签收藏"}),(0,a.jsx)("div",{className:u().bookmarkSubText,children:"加入后可以从浏览器书签找到这本书~"})]}),"source2"===J?(0,a.jsx)("button",{className:u().closeButton,onClick:e=>{e.stopPropagation();try{let e=(0,n.n5)(),t="bookmark_closed_".concat(e,"_").concat(E);localStorage.setItem(t,"true"),s(!1)}catch(e){console.error("保存关闭状态失败:",e),s(!1)}},children:(0,a.jsx)("img",{src:"/close@2x.png",alt:"关闭",width:20,height:20,className:u().closeIcon})}):(0,a.jsx)("button",{className:u().addBookmarkButton,onClick:()=>{if(m)try{let e=(0,n.n5)(),t="bookmark_clicked_".concat(e,"_").concat(E);localStorage.setItem(t,"true"),s(!1),d(!0),setTimeout(()=>{d(!1)},2e3)}catch(e){console.error("保存书签失败:",e)}},children:"加入书签"})]}),l&&(0,a.jsxs)("div",{className:u().toast,children:[(0,a.jsx)("span",{className:u().toastText,children:"已加入书签收藏"}),(0,a.jsx)("span",{className:u().toastSubText,children:"下次你可以从浏览器书签找到这本书"})]})]})}function m(){return(0,a.jsx)(o.Suspense,{fallback:(0,a.jsx)("div",{children:"Loading..."}),children:(0,a.jsx)(d,{})})}},5481:function(e,t,r){"use strict";r.d(t,{AT:function(){return l},Kr:function(){return p},V4:function(){return u},Z:function(){return m},mG:function(){return d},n5:function(){return s},sk:function(){return i}});var a=r(6161),o=r.n(a);let c="https://config.umeweb.cn";function n(e){let t=Object.keys(e).filter(e=>"sign"!==e).sort((e,t)=>e.localeCompare(t)).map(t=>"".concat(t).concat(e[t])).join(""),r="".concat("weimi_novel_key_20251223").concat(t).toLowerCase();return o().MD5(r).toString()}function s(){try{let e="novel_user_id",t=localStorage.getItem(e);if(!t){t=Date.now().toString(36)+Math.random().toString(36).substr(2,5);try{localStorage.setItem(e,t)}catch(e){console.warn("localStorage 不可用，使用临时用户 ID:",e)}}return t}catch(e){return console.warn("获取用户 ID 失败，使用临时 ID:",e),Date.now().toString(36)+Math.random().toString(36).substr(2,5)}}async function i(){try{var e;let t=s(),r=Date.now().toString(),a={uid:t,timestamp:r},o=n(a);a.sign=o,console.log("请求推荐小说，参数:",{uid:t,timestamp:r,sign:o.substring(0,8)+"..."});let i=await fetch("".concat(c,"/browser_business/novel/recommend"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(console.log("API 响应状态:",i.status,i.statusText),!i.ok){let e=await i.text();throw console.error("HTTP 错误响应:",e),Error("HTTP error! status: ".concat(i.status,", message: ").concat(e.substring(0,100)))}let l=await i.json();if(console.log("API 返回数据:",{code:l.code,hasResult:!!l.result,resultLength:null===(e=l.result)||void 0===e?void 0:e.length}),200!==l.code){let e=l.message||"获取推荐小说失败";throw console.error("API 返回错误:",e,l),Error(e)}let u=(l.result||[]).map((e,t)=>({id:e.cbid,title:e.title,author:e.author,status:e.status,cover:e.cover,freeType:e.freeType,category:e.category,recommend:e.recommend,bookshelf:e.bookshelf}));return console.log("成功获取小说列表，数量:",u.length),u}catch(e){if(console.error("获取推荐小说失败:",e),e instanceof TypeError&&e.message.includes("fetch"))throw Error("网络请求失败，请检查网络连接");if(e instanceof Error)throw e;throw Error("获取推荐小说失败，请稍后重试")}}async function l(){try{let e=Date.now().toString(),t=n({timestamp:e}),r=await fetch("".concat(c,"/browser_business/novel/category"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sign:t,timestamp:parseInt(e)})});if(!r.ok)throw Error("HTTP error! status: ".concat(r.status));let a=await r.json();if(200!==a.code)throw Error(a.message||"获取分类列表失败");let o=a.result||{},s=[];return o["1"]&&o["1"].length>0&&s.push({type:"男频",list:o["1"].map((e,t)=>({id:t+1,name:e.category,image:e.cover}))}),o["2"]&&o["2"].length>0&&s.push({type:"女频",list:o["2"].map((e,t)=>({id:t+1,name:e.category,image:e.cover}))}),o["3"]&&o["3"].length>0&&s.push({type:"出版物",list:o["3"].map((e,t)=>({id:t+1,name:e.category,image:e.cover}))}),s}catch(e){throw console.error("获取分类列表失败:",e),e}}async function u(e){try{let t=Date.now().toString(),r=e.pageNum||1,a=e.pageSize||20,o={timestamp:t,pageNum:r.toString(),pageSize:a.toString(),category:e.category,freeType:e.freeType.toString()},s=n(o),i=await fetch("".concat(c,"/browser_business/novel/category_list"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sign:s,timestamp:parseInt(t),pageNum:r,pageSize:a,category:e.category,freeType:e.freeType})});if(!i.ok)throw Error("HTTP error! status: ".concat(i.status));let l=await i.json();if(200!==l.code)throw Error(l.message||"获取分类列表失败");let u=l.result||{total:0,pages:0,data:[]};return{books:u.data.map(e=>({id:e.cbid,cbid:e.cbid,title:e.title,intro:e.intro||"",freeTypeName:e.freeTypeName||"",categoryName:e.categoryName||"",subCategoryName:e.subCategoryName||"",allWords:e.allWords||0,allChapter:e.allChapter||0,freeChapters:e.freeChapters||0,authorName:e.authorName||"",coverUrl:e.coverUrl||"",status:e.status||"连载",tags:e.tags||[],updateTime:e.updateTime||"",site:e.site||""})),total:u.total,pages:u.pages}}catch(e){throw console.error("获取分类列表失败:",e),e}}async function d(e){try{let t=Date.now().toString(),r=n({timestamp:t,cbid:e}),a=await fetch("".concat(c,"/browser_business/novel/info"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cbid:e,sign:r,timestamp:parseInt(t)})});if(!a.ok)throw Error("HTTP error! status: ".concat(a.status));let o=await a.json();if(200!==o.code)throw Error(o.message||"获取书籍详情失败");let s=o.result||{};return{id:s.cbid,cbid:s.cbid,title:s.title||"",authorName:s.authorName||"",site:s.site?"来源".concat(s.site):"",coverUrl:s.coverUrl||"",intro:s.intro||"",status:s.status||"连载",freeTypeName:s.freeTypeName||"",categoryName:s.categoryName||"",subCategoryName:s.subCategoryName||"",allWords:s.allWords||0,allChapter:s.allChapter||0,freeChapters:s.freeChapters||0,tags:s.tags||[],updateTime:s.updateTime||""}}catch(e){throw console.error("获取书籍详情失败:",e),e}}async function m(e){try{let t=Date.now().toString(),r=e.pageNum||1,a=e.pageSize||20,o={timestamp:t,cbid:e.cbid,pageNum:r.toString(),pageSize:a.toString()},s=n(o),i=await fetch("".concat(c,"/browser_business/novel/chapter_list"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cbid:e.cbid,pageNum:r,pageSize:a,sign:s,timestamp:parseInt(t)})});if(!i.ok)throw Error("HTTP error! status: ".concat(i.status));let l=await i.json();if(200!==l.code)throw Error(l.message||"获取章节列表失败");return l.result||{totalCount:0,resultData:[],pages:0}}catch(e){throw console.error("获取章节列表失败:",e),e}}async function p(e){try{let t=Date.now().toString(),r=e.uid||s(),a={timestamp:t,cbid:e.cbid,uid:r,ccid:e.ccid},o=n(a),i=await fetch("".concat(c,"/browser_business/novel/chapter_content"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cbid:e.cbid,uid:r,ccid:e.ccid,sign:o,timestamp:parseInt(t)})});if(!i.ok)throw Error("HTTP error! status: ".concat(i.status));let l=await i.json();if(200!==l.code)throw Error(l.message||"获取章节内容失败");return l.result||{}}catch(e){throw console.error("获取章节内容失败:",e),e}}},2629:function(e){e.exports={header:"page_header__tJswG",bookTitle:"page_bookTitle__nB6K4",catalogButton:"page_catalogButton__kQHNb",content:"page_content__tDp9i",chapterTitle:"page_chapterTitle__ZWROj",textContent:"page_textContent__weOFt",paragraph:"page_paragraph__2Jn_S",bookmarkBar:"page_bookmarkBar__me33Y",bookmarkTextContainer:"page_bookmarkTextContainer__4jkFc",bookmarkText:"page_bookmarkText__N0V0Y",bookmarkSubText:"page_bookmarkSubText__cC6cZ",addBookmarkButton:"page_addBookmarkButton__2BwTb",bookmarkBarBubble:"page_bookmarkBarBubble__jZPWQ",closeButton:"page_closeButton__iAIB4",closeIcon:"page_closeIcon__T2Ycu",toast:"page_toast__SJ9qA",fadeInOut:"page_fadeInOut__fC006",toastText:"page_toastText__EkcSR",toastSubText:"page_toastSubText__Ckyw9"}},6289:function(e){e.exports={pageBase:"common_pageBase__qitDy",pageBase2:"common_pageBase2__OVo5w",bannerBgBase:"common_bannerBgBase__X4J1N",bannerBlurBase:"common_bannerBlurBase__03GAE",bannerBlur2Base:"common_bannerBlur2Base__yimuN",headerBase:"common_headerBase__zHnZO",backButtonBase:"common_backButtonBase__pJynL",backIconBase:"common_backIconBase__LIW2m",headerWithBackBase:"common_headerWithBackBase__ZrM5F"}}},function(e){e.O(0,[541,264,170,842,744],function(){return e(e.s=4816)}),_N_E=e.O()}]);