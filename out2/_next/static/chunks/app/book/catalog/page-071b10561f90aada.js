(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[638],{1054:function(){},6490:function(e,t,r){Promise.resolve().then(r.bind(r,3790))},3790:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return p}});var a=r(9533),s=r(1229),o=r(1250),n=r(5481),c=r(6289),i=r.n(c),l=r(8763),u=r.n(l);function d(){let e=(0,o.useRouter)(),t=(0,o.useSearchParams)().get("id"),[r,c]=(0,s.useState)("asc"),[l,d]=(0,s.useState)([]),[p,h]=(0,s.useState)(!0),[g,m]=(0,s.useState)(!1),[f,_]=(0,s.useState)(null),[y,b]=(0,s.useState)(1),[T,v]=(0,s.useState)(!0),[w,N]=(0,s.useState)(0),[x,S]=(0,s.useState)(0),j=(0,s.useRef)(null),k=(0,s.useRef)(!1),C=(0,s.useRef)(1),B=(0,s.useRef)(0),I=(0,s.useRef)(0),E=(0,s.useRef)(!0),O=(0,s.useRef)("asc"),R=(0,s.useRef)(0);(0,s.useRef)(0);let P=e=>{try{let r=(0,n.n5)(),a="currentReading_".concat(r,"_").concat(t),s=localStorage.getItem(a);if(s){let t=JSON.parse(s);if(t.chapterId===e)return t.progress||0}let o="bookmarks_".concat(r,"_").concat(t),c=localStorage.getItem(o);if(c){let t=JSON.parse(c).find(t=>t.chapterId===e);if(t)return t.progress||0}}catch(e){console.error("获取阅读进度失败:",e)}return 0},D=(0,s.useCallback)(async function(e){let r=arguments.length>1&&void 0!==arguments[1]&&arguments[1],a=arguments.length>2?arguments[2]:void 0;if(k.current)return;let s=null!=a?a:100,o=O.current;try{r?h(!0):m(!0),_(null),k.current=!0;let a=await (0,n.Z)({cbid:t,pageNum:e,pageSize:s});if(a.resultData&&a.resultData.length>0){let t=a.resultData.map(e=>({ccid:e.ccid,chapterTitle:e.chapterTitle||"",actualWords:e.actualWords||e.originalWords||0,progress:P(e.ccid),volumeName:e.volumeName||void 0,chapterOrder:e.chapterOrder||0}));d(e=>{let r=new Set(e.map(e=>e.ccid)),a=t.filter(e=>!r.has(e.ccid));return[...e,...a]}),N(a.totalCount),I.current=a.totalCount;let r=a.pages||Math.ceil(a.totalCount/s);if(a.pages&&a.pages>0?(S(a.pages),B.current=a.pages):(S(r),B.current=r),"desc"===o){let t=e>1;v(t),E.current=t;let r=e>1?e-1:1;b(r),C.current=r}else d(s=>{let o=[...s,...t.filter(e=>!new Set(s.map(e=>e.ccid)).has(e.ccid))].length<a.totalCount||e<r;v(o),E.current=o;let n=e+1;return b(n),C.current=n,s})}else if("desc"===o){let t=e>1;v(t),E.current=t;let r=e>1?e-1:1;b(r),C.current=r}else{let t=B.current,r=e<t;v(r),E.current=r;let a=r?e+1:e;b(a),C.current=a}}catch(e){console.error("获取章节列表失败:",e),_(e instanceof Error?e.message:"获取章节列表失败")}finally{r?h(!1):m(!1),k.current=!1}},[t,r]);(0,s.useEffect)(()=>{t&&("desc"===r?D(1,!0).then(()=>{let e=B.current;e>0&&(d([]),I.current,D(e,!0))}):D(1,!0))},[t,r,D]),(0,s.useEffect)(()=>{if(!j.current||p)return;let e=null,t=0,r=()=>{t++;let r=j.current;r&&!k.current&&(e&&clearTimeout(e),e=setTimeout(()=>{let e=r.scrollTop,t=r.scrollHeight,a=r.clientHeight,s=E.current,o=C.current;t-e-a<100&&s&&!k.current&&(O.current,D(o,!1))},200))},a=j.current;return a&&setTimeout(()=>{let e=a.scrollHeight,t=a.clientHeight,r=E.current,s=C.current;e>t||!r||k.current||0!==R.current||(R.current=1,D(s,!1))},800),a.addEventListener("scroll",r,{passive:!0}),()=>{a.removeEventListener("scroll",r),e&&clearTimeout(e)}},[p,T,D]);let H=[...l].sort((e,t)=>"desc"===r?t.chapterOrder-e.chapterOrder:e.chapterOrder-t.chapterOrder);return(0,a.jsxs)("main",{className:i().pageBase2,children:[(0,a.jsxs)("header",{className:u().header,children:[(0,a.jsx)("button",{className:i().backButtonBase,onClick:()=>e.push("/book?id=".concat(t)),children:(0,a.jsx)("img",{src:"/fh@2x.png",alt:"返回",width:32,height:32,className:i().backIconBase})}),(0,a.jsxs)("button",{className:u().sortButton,onClick:()=>{let e="desc"===r?"asc":"desc";if(c(e),O.current=e,d([]),b(1),C.current=1,v(!0),E.current=!0,R.current=0,"desc"===e){let e=B.current;e>0?D(e,!0):D(1,!0).then(()=>{let e=B.current;e>0&&(d([]),D(e,!0))})}else v(!0),E.current=!0,b(1),C.current=1,D(1,!0)},children:[(0,a.jsx)("span",{className:u().sortText,children:"desc"===r?"倒序":"正序"}),(0,a.jsx)("img",{src:"desc"===r?"/dx@2x.png":"/zx@2x.png",alt:"desc"===r?"倒序":"正序",width:18,height:18,className:u().sortIcon})]})]}),(0,a.jsx)("div",{className:u().divider}),(0,a.jsxs)("div",{className:u().content,ref:j,children:[(0,a.jsx)("div",{className:u().chapterList0,onClick:()=>e.push("/book?id=".concat(t)),children:"书封页"}),(0,a.jsx)("div",{className:u().divider}),p?(0,a.jsx)("div",{style:{padding:"20px",textAlign:"center",color:"#666"},children:"加载中..."}):f?(0,a.jsx)("div",{style:{padding:"20px",textAlign:"center",color:"#f06e2b"},children:f}):0===H.length?(0,a.jsx)("div",{style:{padding:"20px",textAlign:"center",color:"#666"},children:"暂无章节数据"}):H.map((r,s)=>{var o;let n=r.volumeName&&(0===s||(null===(o=H[s-1])||void 0===o?void 0:o.volumeName)!==r.volumeName);return(0,a.jsxs)("div",{children:[n&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:u().volumeTitle,children:r.volumeName}),(0,a.jsx)("div",{className:u().divider})]}),(0,a.jsx)("div",{className:u().chapterItem,onClick:()=>e.push("/book/read?id=".concat(t,"&chapter=").concat(r.ccid)),children:r.progress>0?(0,a.jsxs)("div",{className:u().chapterInfoRead,children:[(0,a.jsxs)("div",{className:u().chapterTitleRow,children:[(0,a.jsx)("span",{className:"".concat(u().chapterTitle," ").concat(u().chapterTitleRead),children:r.chapterTitle}),(0,a.jsxs)("span",{className:u().progress,children:["已读",r.progress,"%"]})]}),(0,a.jsxs)("span",{className:u().wordCount,children:[r.actualWords,"字"]})]}):(0,a.jsxs)("div",{className:u().chapterInfo,children:[(0,a.jsx)("span",{className:u().chapterTitle,children:r.chapterTitle}),(0,a.jsx)("div",{className:u().chapterMeta,children:(0,a.jsxs)("span",{className:u().wordCount,children:[r.actualWords,"字"]})})]})}),(0,a.jsx)("div",{className:u().divider})]},r.ccid)}),g&&(0,a.jsx)("div",{style:{padding:"20px",textAlign:"center",color:"#666"},children:"加载更多章节中..."}),l.length>0&&("desc"===r&&y<=1||"asc"===r&&!T)&&(0,a.jsx)("div",{style:{padding:"20px",textAlign:"center",color:"#999"},children:"已加载全部章节"})]})]})}function p(){return(0,a.jsx)(s.Suspense,{fallback:(0,a.jsx)("div",{children:"Loading..."}),children:(0,a.jsx)(d,{})})}},5481:function(e,t,r){"use strict";r.d(t,{AT:function(){return l},Kr:function(){return h},V4:function(){return u},Z:function(){return p},mG:function(){return d},n5:function(){return c},sk:function(){return i}});var a=r(6161),s=r.n(a);let o="https://config.umeweb.cn";function n(e){let t=Object.keys(e).filter(e=>"sign"!==e).sort((e,t)=>e.localeCompare(t)).map(t=>"".concat(t).concat(e[t])).join(""),r="".concat("weimi_novel_key_20251223").concat(t).toLowerCase();return s().MD5(r).toString()}function c(){try{let e="novel_user_id",t=localStorage.getItem(e);if(!t){t=Date.now().toString(36)+Math.random().toString(36).substr(2,5);try{localStorage.setItem(e,t)}catch(e){console.warn("localStorage 不可用，使用临时用户 ID:",e)}}return t}catch(e){return console.warn("获取用户 ID 失败，使用临时 ID:",e),Date.now().toString(36)+Math.random().toString(36).substr(2,5)}}async function i(){try{var e;let t=c(),r=Date.now().toString(),a={uid:t,timestamp:r},s=n(a);a.sign=s,console.log("请求推荐小说，参数:",{uid:t,timestamp:r,sign:s.substring(0,8)+"..."});let i=await fetch("".concat(o,"/browser_business/novel/recommend"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(console.log("API 响应状态:",i.status,i.statusText),!i.ok){let e=await i.text();throw console.error("HTTP 错误响应:",e),Error("HTTP error! status: ".concat(i.status,", message: ").concat(e.substring(0,100)))}let l=await i.json();if(console.log("API 返回数据:",{code:l.code,hasResult:!!l.result,resultLength:null===(e=l.result)||void 0===e?void 0:e.length}),200!==l.code){let e=l.message||"获取推荐小说失败";throw console.error("API 返回错误:",e,l),Error(e)}let u=(l.result||[]).map((e,t)=>({id:e.cbid,title:e.title,author:e.author,status:e.status,cover:e.cover,freeType:e.freeType,category:e.category,recommend:e.recommend,bookshelf:e.bookshelf}));return console.log("成功获取小说列表，数量:",u.length),u}catch(e){if(console.error("获取推荐小说失败:",e),e instanceof TypeError&&e.message.includes("fetch"))throw Error("网络请求失败，请检查网络连接");if(e instanceof Error)throw e;throw Error("获取推荐小说失败，请稍后重试")}}async function l(){try{let e=Date.now().toString(),t=n({timestamp:e}),r=await fetch("".concat(o,"/browser_business/novel/category"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sign:t,timestamp:parseInt(e)})});if(!r.ok)throw Error("HTTP error! status: ".concat(r.status));let a=await r.json();if(200!==a.code)throw Error(a.message||"获取分类列表失败");let s=a.result||{},c=[];return s["1"]&&s["1"].length>0&&c.push({type:"男频",list:s["1"].map((e,t)=>({id:t+1,name:e.category,image:e.cover}))}),s["2"]&&s["2"].length>0&&c.push({type:"女频",list:s["2"].map((e,t)=>({id:t+1,name:e.category,image:e.cover}))}),s["3"]&&s["3"].length>0&&c.push({type:"出版物",list:s["3"].map((e,t)=>({id:t+1,name:e.category,image:e.cover}))}),c}catch(e){throw console.error("获取分类列表失败:",e),e}}async function u(e){try{let t=Date.now().toString(),r=e.pageNum||1,a=e.pageSize||20,s={timestamp:t,pageNum:r.toString(),pageSize:a.toString(),category:e.category,freeType:e.freeType.toString()},c=n(s),i=await fetch("".concat(o,"/browser_business/novel/category_list"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sign:c,timestamp:parseInt(t),pageNum:r,pageSize:a,category:e.category,freeType:e.freeType})});if(!i.ok)throw Error("HTTP error! status: ".concat(i.status));let l=await i.json();if(200!==l.code)throw Error(l.message||"获取分类列表失败");let u=l.result||{total:0,pages:0,data:[]};return{books:u.data.map(e=>({id:e.cbid,cbid:e.cbid,title:e.title,intro:e.intro||"",freeTypeName:e.freeTypeName||"",categoryName:e.categoryName||"",subCategoryName:e.subCategoryName||"",allWords:e.allWords||0,allChapter:e.allChapter||0,freeChapters:e.freeChapters||0,authorName:e.authorName||"",coverUrl:e.coverUrl||"",status:e.status||"连载",tags:e.tags||[],updateTime:e.updateTime||"",site:e.site||""})),total:u.total,pages:u.pages}}catch(e){throw console.error("获取分类列表失败:",e),e}}async function d(e){try{let t=Date.now().toString(),r=n({timestamp:t,cbid:e}),a=await fetch("".concat(o,"/browser_business/novel/info"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cbid:e,sign:r,timestamp:parseInt(t)})});if(!a.ok)throw Error("HTTP error! status: ".concat(a.status));let s=await a.json();if(200!==s.code)throw Error(s.message||"获取书籍详情失败");let c=s.result||{};return{id:c.cbid,cbid:c.cbid,title:c.title||"",authorName:c.authorName||"",site:c.site?"来源".concat(c.site):"",coverUrl:c.coverUrl||"",intro:c.intro||"",status:c.status||"连载",freeTypeName:c.freeTypeName||"",categoryName:c.categoryName||"",subCategoryName:c.subCategoryName||"",allWords:c.allWords||0,allChapter:c.allChapter||0,freeChapters:c.freeChapters||0,tags:c.tags||[],updateTime:c.updateTime||""}}catch(e){throw console.error("获取书籍详情失败:",e),e}}async function p(e){try{let t=Date.now().toString(),r=e.pageNum||1,a=e.pageSize||20,s={timestamp:t,cbid:e.cbid,pageNum:r.toString(),pageSize:a.toString()},c=n(s),i=await fetch("".concat(o,"/browser_business/novel/chapter_list"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cbid:e.cbid,pageNum:r,pageSize:a,sign:c,timestamp:parseInt(t)})});if(!i.ok)throw Error("HTTP error! status: ".concat(i.status));let l=await i.json();if(200!==l.code)throw Error(l.message||"获取章节列表失败");return l.result||{totalCount:0,resultData:[],pages:0}}catch(e){throw console.error("获取章节列表失败:",e),e}}async function h(e){try{let t=Date.now().toString(),r=e.uid||c(),a={timestamp:t,cbid:e.cbid,uid:r,ccid:e.ccid},s=n(a),i=await fetch("".concat(o,"/browser_business/novel/chapter_content"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cbid:e.cbid,uid:r,ccid:e.ccid,sign:s,timestamp:parseInt(t)})});if(!i.ok)throw Error("HTTP error! status: ".concat(i.status));let l=await i.json();if(200!==l.code)throw Error(l.message||"获取章节内容失败");return l.result||{}}catch(e){throw console.error("获取章节内容失败:",e),e}}},8763:function(e){e.exports={header:"page_header__Ot9Qe",sortButton:"page_sortButton__JU91J",sortText:"page_sortText__63OXx",sortIcon:"page_sortIcon__F5atN",chapterList0:"page_chapterList0__lom98",content:"page_content__qxGMw",volumeTitle:"page_volumeTitle__TPk5k",divider:"page_divider__lKiEf",chapterItem:"page_chapterItem__Rknvi",chapterInfo:"page_chapterInfo___ExB3",chapterInfoRead:"page_chapterInfoRead__Nod4e",chapterTitleRow:"page_chapterTitleRow__6j67u",chapterTitle:"page_chapterTitle__uIKth",chapterTitleRead:"page_chapterTitleRead__nkmQG",chapterMeta:"page_chapterMeta__UCYeC",wordCount:"page_wordCount__ilapA",progress:"page_progress__bXz68"}},6289:function(e){e.exports={pageBase:"common_pageBase__qitDy",pageBase2:"common_pageBase2__OVo5w",bannerBgBase:"common_bannerBgBase__X4J1N",bannerBlurBase:"common_bannerBlurBase__03GAE",bannerBlur2Base:"common_bannerBlur2Base__yimuN",headerBase:"common_headerBase__zHnZO",backButtonBase:"common_backButtonBase__pJynL",backIconBase:"common_backIconBase__LIW2m",headerWithBackBase:"common_headerWithBackBase__ZrM5F"}}},function(e){e.O(0,[541,264,170,842,744],function(){return e(e.s=6490)}),_N_E=e.O()}]);